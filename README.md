# Music-EEG Multimodal Experiment Paradigm
# 音乐-脑电多模态实验范式上位机

## 📖 项目简介
本项目是一个用于采集音乐收听过程中脑电（EEG）信号的上位机实验程序。程序能够同步播放音乐、全屏展示歌词，并通过蓝牙（BLE）实时采集便携式 EEG 设备的信号，最终将数据保存为 CSV 文件供后续分析使用。

旨在为多模态（音频+文本+脑电）情感计算或认知研究提供标准化的数据采集工具。

## ✨ 功能特性
- **🎵 音乐播放与歌词同步**：支持 MP3 音乐播放及同步的全屏歌词展示（高亮显示）。
- **📡 蓝牙 EEG 采集**：通过 BLE (Bleak) 连接 EEG 设备，实时接收并解析数据包。
- **🔄 LSL 数据流集成**：集成 Lab Streaming Layer (LSL) 协议，支持标准化的数据流分发。
- **⚡ 多线程高性能记录**：
    - 采用多线程 + 锁机制（Thread-Safe），确保数据采集、解析与写入互不干扰。
    - 实现了**异步保存**策略，停止录制时界面无卡顿，数据零丢失。
- **🧪 实验流程控制**：
    - **3秒准备期**：每首歌开始前有 3秒倒计时，提示受试者保持静止。
    - **严格同步**：音乐播放与 EEG 采集启动/停止严格对齐，误差控制在毫秒级。
    - **批量执行**：支持全选/单选歌曲，按顺序自动执行播放列表。
- **📂 数据自动管理**：
    - 自动按日期生成实验文件夹（如 `offlinedata/EEGdata-0209-1`）。
    - 自动命名数据文件（格式：`Category_{ID}_{歌名}.csv`）。
    - 实时日志记录：包括实际采样率（Effective Rate）和采集时长监控。

## 🛠️ 环境要求
- **操作系统**：Windows 10/11 (推荐，需支持蓝牙 4.0+)
- **Python 版本**：Python 3.8+

## 📦 安装与配置

1. **克隆或下载项目**到本地目录。

2. **安装依赖库**
   建议使用虚拟环境：
   ```bash
   pip install -r requirements.txt
   ```
   *核心依赖包括：`PyQt6` (UI), `pygame` (音频), `bleak` (蓝牙), `numpy`, `pandas`, `pylsl` (数据流)*

3. **准备素材**
   - 将 `.mp3` 音乐文件放入 `Musics/` 目录。
   - 将对应的 `.txt` 歌词文件放入 `Lyrics/` 目录（文件名需与音乐一致）。

## 🚀 运行说明

1. **启动程序**
   ```bash
   python main.py
   ```

2. **操作步骤**
   - **Step 1 连接设备**：在左侧面板输入蓝牙设备名称（默认 "MSM"），点击“连接设备”。等待状态栏显示“连接成功”。
   - **Step 2 选择歌曲**：在右侧网格中勾选参与本次实验的歌曲（支持“全选”）。
   - **Step 3 开始实验**：点击左侧“开始实验”大按钮。
   - **Step 4 实验进行**：
     - 屏幕进入全屏模式，显示歌词。
     - 受试者在 3秒准备期后开始聆听。
     - 音乐结束后自动保存数据并进入下一首。
   - **Step 5 结束**：所有歌曲播放完毕后，程序自动退出全屏并提示完成。

3. **异常中断**
   - 在实验过程中按 **`ESC`** 键可强行中止当前实验，并保存已采集的数据。

## 📁 输出数据
所有数据保存在 `offlinedata/` 目录下。
- **目录结构**：`EEGdata-{MMDD}-{Index}` (例如 `EEGdata-0209-2`)
- **文件格式**：CSV 文件
- **命名规范**：`Category_{ID}_{SongName}.csv`
  - `ID`：歌曲编号（对应类别）
  - `SongName`：歌曲名称

## 🔍 常见问题 (FAQ)
- **Q: 为什么采集到的数据长度与音乐时长不完全一致？**
  - A: 蓝牙传输存在物理延迟和丢包可能。程序已优化同步逻辑，通常误差在 0.5s 以内。日志中会打印 `Effective Rate`，约为 420Hz 左右。
- **Q: 蓝牙连接失败？**
  - A: 请检查电脑蓝牙是否开启，设备是否电量充足且未连接其他主机。